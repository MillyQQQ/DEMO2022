# DEMO2022

# Образец задания
Образец задания для демонстрационного экзамена по комплекту оценочной
документации.

# Описание задания
# Модуль 1
Вариант 1-0 (публичный)

![DEMO2022azure-Page-5 drawio (1)](https://user-images.githubusercontent.com/79700810/152940108-a33f9a43-91e4-4709-811a-215c52bff54b.png)

## Виртуальные машины и коммутация.
Необходимо выполнить создание и базовую конфигурацию виртуальных
машин.

1. На основе предоставленных ВМ или шаблонов ВМ создайте отсутствующие виртуальные машины в соответствии со схемой.  
   -	Характеристики ВМ установите в соответствии с Таблицей 1;
   -	Коммутацию (если таковая не выполнена) выполните в соответствии со схемой сети.	 
2.  Имена хостов в созданных ВМ должны быть установлены в соответствии со схемой.
3.  Адресация должна быть выполнена в соответствии с Таблицей 1;
4.  Обеспечьте ВМ дополнительными дисками, если таковое необходимо в соответствии с Таблицей 1;

## Таблица 1. Характеристики ВМ

|Name VM         |ОС                  |Size            |CPU /RAM        |IP                  |Additionally                       |
|  ------------- | -------------      | -------------  |  ------------- |  -------------     |  -------------                    |  
|RTR-L           |Debian 11       |Standard B2s    |2/4             |10.0.1.5/24         |       public-ip                   |
|                |                    |                |                |10.0.2.5/24         |                                   |
|RTR-R           |Debian 11       |Standard B2s    |2/4             |172.16.1.5/24       |    public-ip                      |
|                |                    |                |                |172.16.2.5 /24      |                                   |
|SRV             |Win 2019  |Standard B2s      |2/4           |10.0.2.7/24         |Доп диски 2 шт по 5 GB             |
|WEB-L           |Debian 11          |Standard B2s    |2/4             |10.0.2.6/24        |                       |
|WEB-R           |Debian 11          |Standard B2s    |2/4             |172.16.2.6/24        |                       |
|ISP           |Debian 11          |Standard B2s    |2/4             |192.168.1.5/24        |        public-ip               |
|CLI             |Win 10              |Physical PS           |2/4               |any           |          internet                         |


### 1. На основе предоставленных ВМ или шаблонов ВМ создайте отсутствующие виртуальные машины в соответствии со схемой.
Убедитесь что все ВМ созданы в соотведствии со схемой

![image](https://user-images.githubusercontent.com/79700810/152943647-dd51a1cf-09a8-470b-a8b2-06a8011cc91a.png)

### 2.  Имена хостов в созданных ВМ должны быть установлены в соответствии со схемой.
При работе в Azure все имена будут сконфигурированы зарание
### 3.  Адресация должна быть выполнена в соответствии с Таблицей 1;
При работе в Azure все ip адреса будут сконфигурированы зарание

## Сетевая связность.
В рамках данного модуля требуется обеспечить сетевую связность между
регионами работы приложения, а также обеспечить выход ВМ в имитируемую
сеть “Интернет”

1. Сети, подключенные к ISP, считаются внешними:
   - Запрещено прямое попадание трафика из внутренних сетей во внешние и наоборот;
2. Платформы контроля трафика, установленные на границах регионов, должны выполнять трансляцию трафика, идущего из соответствующих внутренних сетей во внешние сети стенда и в сеть Интернет.
   - Трансляция исходящих адресов производится в адрес платформы,расположенный во внешней сети.    
3. Между платформами должен быть установлен защищенный туннель, позволяющий осуществлять связь между регионами с применением внутренних адресов.
   - Трафик, проходящий по данному туннелю, должен быть защищен:
     - Платформа ISP не должна иметь возможности просматривать содержимое пакетов, идущих из одной внутренней сети в другую.
   - Туннель должен позволять защищенное взаимодействие между платформами управления трафиком по их внутренним адресам
     - Взаимодействие по внешним адресам должно происходит без применения туннеля и шифрования
   - Трафик, идущий по туннелю между регионами по внутренним адресам, не должен транслироваться.
 4. Платформа управления трафиком RTR-L выполняет контроль входящего трафика согласно следующим правилам:
    - Разрешаются подключения к портам DNS, HTTP и HTTPS для всех клиентов;
      - Порты необходимо для работы настраиваемых служб
    - Разрешается работа выбранного протокола организации защищенной связи; 
      - Разрешение портов должно быть выполнено по принципу “необходимо и достаточно”
    - Разрешается работа протоколов ICMP;
    - Разрешается работа протокола SSH;
    - Прочие подключения запрещены;
    - Для обращений в платформам со стороны хостов, находящихся внутри регионов, ограничений быть не должно;
5. Платформа управления трафиком RTR-R выполняет контроль входящего трафика согласно следующим правилам:
   - Разрешаются подключения к портам HTTP и HTTPS для всех клиентов;
     - Порты необходимо для работы настраиваемых служб
   - Разрешается работа выбранного протокола организации защищенной связи;
     - Разрешение портов должно быть выполнено по принципу необходимо и достаточно”
   - Разрешается работа протоколов ICMP;
   - Разрешается работа протокола SSH;
   - Прочие подключения запрещены;
   - Для обращений в платформам со стороны хостов, находящихся внутри регионов, ограничений быть не должно;
6. Обеспечьте настройку служб SSH региона Left и Right:
   - Подключения со стороны внешних сетей по протоколу к платформе управления трафиком RTR-L на порт 2222 должны быть перенаправлены на ВМ Web-L;
   - Подключения со стороны внешних сетей по протоколу к платформе управления трафиком RTR-R на порт 2244 должны быть перенаправлены на ВМ Web-R;

### 1. Сети, подключенные к ISP, считаются внешними:

#### RTR-L
Подключаемся по ssh к public-ip RTR-L

```debian
sudo -i
```

```debian
  net.ipv4.ip_forward=1
```

```debian
sysctl -p
```

#### RTR-R
Подключаемся по ssh к public-ip RTR-R

```debian
sudo -i
```

```debian
  net.ipv4.ip_forward=1
```

```debian
sysctl -p
```


### 2. Платформы контроля трафика, установленные на границах регионов, должны выполнять трансляцию трафика, идущего из соответствующих внутренних сетей во внешние сети стенда и в сеть Интернет.

#### RTR-L

```debian
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

```debian
apt-get -y install iptables-persistent
```


#### RTR-R

```debian
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

```debian
apt-get -y install iptables-persistent
```

### 3. Между платформами должен быть установлен защищенный туннель, позволяющий осуществлять связь между регионами с применением внутренних адресов.

#### RTR-L 

```debian
apt install -y libreswan
```

```debian
nano /etc/ipsec.conf
```

```debian
conn mytunnel
    auto=start
    authby=secret
    type=tunnel
    ike=aes128-sha2;dh14
    ikev2=no
    phase2=esp
    pfs=no
    encapsulation=yes
    leftsubnet=0.0.0.0/0
    rightsubnet=0.0.0.0/0
    left=10.0.1.5
    right=<public-ip-RTR-R>
    rightid=172.16.1.5
    mark=5/0xffffffff
    vti-interface=vti01
    vti-routing=no
    vti-shared=yes
    leftvti=192.168.20.1/30
    rightvti=192.168.20.2/30

include /etc/ipsec.d/*.conf
```

```debian
nano /etc/ipsec.d/test.secrets
```

```debian
%any %any : PSK "TheSecretMustBeAtLeast13bytes"
```

```debian
systemctl restart ipsec.service
```

#### RTR-R


```debian
apt install -y libreswan
```

```debian
nano /etc/ipsec.conf
```

```debian
config setup
    listen=172.16.1.5

conn mytunnel
    auto=start
    authby=secret
    type=tunnel
    ike=aes128-sha2;dh14
    ikev2=no
    phase2=esp
    pfs=no
    encapsulation=yes
    leftsubnet=0.0.0.0/0
    rightsubnet=0.0.0.0/0
    left=<public-ip-RTR-L>
    leftid=10.0.1.5
    right=172.16.1.5
    mark=5/0xffffffff
    vti-interface=vti01
    vti-routing=no
    vti-shared=yes
    leftvti=192.168.20.1/30
    rightvti=192.168.20.2/30

include /etc/ipsec.d/*.conf
```
```debian
%any %any : PSK "TheSecretMustBeAtLeast13bytes"
```

```debian
systemctl restart ipsec.service
```
#### RTR-L

```debian
apt install -y frr
```

```debian
nano /etc/frr/daemons
```

```debian
eigrpd=yes
```

```debian
systemctl restart frr.service
systemctl enable frr
```

```debian
vtysh
```

```debian
conf t
router eigrp 6500
network 10.0.2.0/24 
network 192.168.20.0/30
do wr
```
#### RTR-R

```debian
apt install -y frr
```

```debian
nano /etc/frr/daemons
```

```debian
eigrpd=yes
```

```debian
systemctl restart frr.service
systemctl enable frr
```

```debian
vtysh
```

```debian
conf t
router eigrp 6500
network 172.16.2.0/24 
network 192.168.20.0/30
do wr
```

###  4. Платформа управления трафиком RTR-L выполняет контроль входящего трафика согласно следующим правилам:
#### RTR-L ACL

```debian
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2222 -j DNAT --to 10.0.2.6:22
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 10.0.2.6:80
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to 10.0.2.6:443
iptables -t nat -A PREROUTING -i eth0 -p udp --dport 53 -j DNAT --to 10.0.2.7:53
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3389 -j DNAT --to 10.0.2.7:3389
```

```debian
iptables -A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 500 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 4500 -j ACCEPT
iptables -A INPUT -i eth0 -p esp  -j ACCEPT
iptables -A INPUT -i eth0 -p icmp -j ACCEPT
iptables -A INPUT -i eth0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -i eth0 -j REJECT
```

### 5. Платформа управления трафиком RTR-R выполняет контроль входящего трафика согласно следующим правилам:

#### RTR-R ACL

```debian
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 2244 -j DNAT --to 172.16.2.6:22
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 172.16.2.6:80
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to 172.16.2.6:443
```

```debian
iptables -A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 500 -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 4500 -j ACCEPT
iptables -A INPUT -i eth0 -p esp  -j ACCEPT
iptables -A INPUT -i eth0 -p icmp -j ACCEPT
iptables -A INPUT -i eth0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -i eth0 -j REJECT
```

### 6. Обеспечьте настройку служб SSH региона Left:
При работе в Azure служба ssh будет установлина и сконфигурирована


## Инфраструктурные службы

В рамках данного модуля необходимо настроить основные
инфраструктурные службы и настроить представленные ВМ на применение этих
служб для всех основных функций. 

1. Выполните настройку первого уровня DNS-системы стенда:
   - Используется ВМ ISP;
   - Обслуживается зона demo.wsr
     - Наполнение зоны должно быть реализовано в соответствии с Таблицей 2;
   - Сервер делегирует зону int.demo.wsr на SRV;
     - Поскольку SRV находится во внутренней сети западного региона, делегирование происходит на внешний адрес маршрутизатора данного региона. 
     - Маршрутизатор региона должен транслировать соответствующие порты DNS-службы в порты сервера SRV
   - Внешний клиент CLI должен использовать DNS-службу, развернутую на ISP, по умолчанию;
2. Выполните настройку второго уровня DNS-системы стенда;
   - Используется ВМ SRV;
   - Обслуживается зона int.demo.wsr;
     - Наполнение зоны должно быть реализовано в соответствии с Таблицей 2;
   - Обслуживаются обратные зоны для внутренних адресов регионов
     - Имена для разрешения обратных записей следует брать из Таблицы 2;
   - Сервер принимает рекурсивные запросы, исходящие от адресов внутренних регионов;
     - Обслуживание клиентов(внешних и внутренних),  обращающихся к к зоне int.demo.wsr, должно производится без каких либо ограничений по адресу источника;
   - Внутренние хосты регионов (равно как и платформы управления трафиком) должны использовать данную DNS-службу для разрешения всех запросов имен;
3. Выполните настройку первого уровня системы синхронизации времени:
   - Используется сервер ISP. 
   - Сервер считает собственный источник времени верным, stratum=4;
   - Сервер допускает подключение только через внешний адрес соответствующей платформы управления трафиком;
     - Подразумевается обращение SRV для синхронизации времени;
   - Клиент CLI должен использовать службу времени ISP;
4. Выполните конфигурацию службы второго уровня времени на SRV
   - Сервер синхронизирует время с хостом ISP;
     - Синхронизация с другими источникам запрещена;
   - Сервер должен допускать обращения внутренних хостов регионов, в том числе и платформ управления трафиком, для синхронизации времени;
   - Все внутренние хосты(в том числе и платформы управления трафиком) должны синхронизировать свое время с SRV;
5. Реализуйте файловый SMB-сервер на базе SRV
   - Сервер должен предоставлять доступ для обмена файлами серверам WEB-L и WEB-R;
   - Сервер, в зависимости от ОС, использует следующие каталоги для хранения файлов:
     - /mnt/storage для система на базе Linux;
     - Диск R:\ для систем на базе Windows;
   - Хранение файлов осуществляется на диске (смонтированном по указанным выше адресам), реализованном по технологии RAID типа “Зеркало”;
6. Сервера WEB-L и WEB-R должны использовать службу, настроенную на SRV, для обмена файлами между собой:
   - Служба файлового обмена должна позволять монтирование в виде стандартного каталога Linux
     - Разделяемый каталог должен быть смонтирован по адресу /opt/share;
   - Каталог должен позволять удалять и создавать файлы в нем для всех пользователей;
7. Выполните настройку центра сертификации на базе SRV:
   - В случае применения решения на базе Linux используется центр сертификации типа OpenSSL и располагается по адресу /var/ca
   - Выдаваемые сертификаты должны иметь срок жизни не менее 500 дней;
   - Параметры выдаваемых сертификатов:
     - Страна RU;
     - Организация DEMO.WSR;
     - Прочие поля (за исключением CN) должны быть пусты;


## Таблица 2. DNS-записи зон

|Zone            |Type                |Key             |Meaning         |
|  ------------- | -------------      | -------------  |  ------------- |
| demo.wsr       | A                  | isp            | "<public-ip-ISP>"        |
|                | A                  | www            |<public-ip-RTR-L>      |
|                | A                  | www            | <public-ip-RTR-R>     |
|                | CNAME              | internet       | isp            |
|                | NS                 | int            | rtr-l.demo.wsr      |
|                | A                  | rtr-l       | <public-ip-RTR-L>     |
   

### 1. Выполните настройку первого уровня DNS-системы стенда:
