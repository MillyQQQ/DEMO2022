# DEMO2022

# Образец задания
Образец задания для демонстрационного экзамена по комплекту оценочной
документации.

# Описание задания
# Модуль 1
Вариант 1-0 (публичный)

![DEMO2022azure-Page-5 drawio (1)](https://user-images.githubusercontent.com/79700810/152940108-a33f9a43-91e4-4709-811a-215c52bff54b.png)

## Виртуальные машины и коммутация.
Необходимо выполнить создание и базовую конфигурацию виртуальных
машин.

1. На основе предоставленных ВМ или шаблонов ВМ создайте отсутствующие виртуальные машины в соответствии со схемой.  
   -	Характеристики ВМ установите в соответствии с Таблицей 1;
   -	Коммутацию (если таковая не выполнена) выполните в соответствии со схемой сети.	 
2.  Имена хостов в созданных ВМ должны быть установлены в соответствии со схемой.
3.  Адресация должна быть выполнена в соответствии с Таблицей 1;
4.  Обеспечьте ВМ дополнительными дисками, если таковое необходимо в соответствии с Таблицей 1;

## Таблица 1. Характеристики ВМ

|Name VM         |ОС                  |Size            |CPU /RAM        |IP                  |Additionally                       |
|  ------------- | -------------      | -------------  |  ------------- |  -------------     |  -------------                    |  
|RTR-L           |Debian 11       |Standard B2s    |2/4             |10.0.1.5/24         |       public-ip                   |
|                |                    |                |                |10.0.2.5/24         |                                   |
|RTR-R           |Debian 11       |Standard B2s    |2/4             |172.16.1.5/24       |    public-ip                      |
|                |                    |                |                |172.16.2.5 /24      |                                   |
|SRV             |Win 2019  |Standard B2s      |2/4           |10.0.2.7/24         |Доп диски 2 шт по 5 GB             |
|WEB-L           |Debian 11          |Standard B2s    |2/4             |10.0.2.6/24        |                       |
|WEB-R           |Debian 11          |Standard B2s    |2/4             |172.16.2.6/24        |                       |
|ISP           |Debian 11          |Standard B2s    |2/4             |192.168.1.5/24        |        public-ip               |
|CLI             |Win 10              |Physical PS           |2/4               |any           |          internet                         |


### 1. На основе предоставленных ВМ или шаблонов ВМ создайте отсутствующие виртуальные машины в соответствии со схемой.
Убедитесь что все ВМ созданы в соотведствии со схемой

![image](https://user-images.githubusercontent.com/79700810/152943647-dd51a1cf-09a8-470b-a8b2-06a8011cc91a.png)

### 2.  Имена хостов в созданных ВМ должны быть установлены в соответствии со схемой.
При работе в Azure все имена будут сконфигурированы зарание
### 3.  Адресация должна быть выполнена в соответствии с Таблицей 1;
При работе в Azure все ip адреса будут сконфигурированы зарание

## Сетевая связность.
В рамках данного модуля требуется обеспечить сетевую связность между
регионами работы приложения, а также обеспечить выход ВМ в имитируемую
сеть “Интернет”

1. Сети, подключенные к ISP, считаются внешними:
   - Запрещено прямое попадание трафика из внутренних сетей во внешние и наоборот;
2. Платформы контроля трафика, установленные на границах регионов, должны выполнять трансляцию трафика, идущего из соответствующих внутренних сетей во внешние сети стенда и в сеть Интернет.
   - Трансляция исходящих адресов производится в адрес платформы,расположенный во внешней сети.    
3. Между платформами должен быть установлен защищенный туннель, позволяющий осуществлять связь между регионами с применением внутренних адресов.
   - Трафик, проходящий по данному туннелю, должен быть защищен:
     - Платформа ISP не должна иметь возможности просматривать содержимое пакетов, идущих из одной внутренней сети в другую.
   - Туннель должен позволять защищенное взаимодействие между платформами управления трафиком по их внутренним адресам
     - Взаимодействие по внешним адресам должно происходит без применения туннеля и шифрования
   - Трафик, идущий по туннелю между регионами по внутренним адресам, не должен транслироваться.
 4. Платформа управления трафиком RTR-L выполняет контроль входящего трафика согласно следующим правилам:
    - Разрешаются подключения к портам DNS, HTTP и HTTPS для всех клиентов;
      - Порты необходимо для работы настраиваемых служб
    - Разрешается работа выбранного протокола организации защищенной связи; 
      - Разрешение портов должно быть выполнено по принципу “необходимо и достаточно”
    - Разрешается работа протоколов ICMP;
    - Разрешается работа протокола SSH;
    - Прочие подключения запрещены;
    - Для обращений в платформам со стороны хостов, находящихся внутри регионов, ограничений быть не должно;
5. Платформа управления трафиком RTR-R выполняет контроль входящего трафика согласно следующим правилам:
   - Разрешаются подключения к портам HTTP и HTTPS для всех клиентов;
     - Порты необходимо для работы настраиваемых служб
   - Разрешается работа выбранного протокола организации защищенной связи;
     - Разрешение портов должно быть выполнено по принципу необходимо и достаточно”
   - Разрешается работа протоколов ICMP;
   - Разрешается работа протокола SSH;
   - Прочие подключения запрещены;
   - Для обращений в платформам со стороны хостов, находящихся внутри регионов, ограничений быть не должно;
6. Обеспечьте настройку служб SSH региона Left и Right:
   - Подключения со стороны внешних сетей по протоколу к платформе управления трафиком RTR-L на порт 2222 должны быть перенаправлены на ВМ Web-L;
   - Подключения со стороны внешних сетей по протоколу к платформе управления трафиком RTR-R на порт 2244 должны быть перенаправлены на ВМ Web-R;

### 1. Сети, подключенные к ISP, считаются внешними:

## RTR-L
Подключаемся по ssh к public-ip RTR-L

```debian
sudo -i
```

```debian
  net.ipv4.ip_forward=1
```

```debian
sysctl -p
```

## RTR-R
Подключаемся по ssh к public-ip RTR-R

```debian
sudo -i
```

```debian
  net.ipv4.ip_forward=1
```

```debian
sysctl -p
```


### 2. Платформы контроля трафика, установленные на границах регионов, должны выполнять трансляцию трафика, идущего из соответствующих внутренних сетей во внешние сети стенда и в сеть Интернет.

## RTR-L

```debian
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

```debian
apt-get -y install iptables-persistent
```


## RTR-R

```debian
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

```debian
apt-get -y install iptables-persistent
```

### 3. Между платформами должен быть установлен защищенный туннель, позволяющий осуществлять связь между регионами с применением внутренних адресов.

#### RTR-L 

```debian
apt install -y libreswan
```

```debian
nano /etc/ipsec.conf
```

```debian
conn mytunnel
    auto=start
    authby=secret
    type=tunnel
    ike=aes128-sha2;dh14
    ikev2=no
    phase2=esp
    pfs=no
    encapsulation=yes
    leftsubnet=0.0.0.0/0
    rightsubnet=0.0.0.0/0
    left=10.0.1.5
    right=13.81.175.209
    rightid=172.16.1.5
    mark=5/0xffffffff
    vti-interface=vti01
    vti-routing=no
    vti-shared=yes
    leftvti=192.168.20.1/30
    rightvti=192.168.20.2/30

include /etc/ipsec.d/*.conf
```

```debian
nano /etc/ipsec.d/test.secrets
```

```debian
%any %any : PSK "TheSecretMustBeAtLeast13bytes"
```

```debian
systemctl restart ipsec.service
```

#### RTR-R


```debian
apt install -y libreswan
```

```debian
nano /etc/ipsec.conf
```

```debian
config setup
    listen=172.16.1.5

conn mytunnel
    auto=start
    authby=secret
    type=tunnel
    ike=aes128-sha2;dh14
    ikev2=no
    phase2=esp
    pfs=no
    encapsulation=yes
    leftsubnet=0.0.0.0/0
    rightsubnet=0.0.0.0/0
    left=13.94.188.114
    leftid=10.0.1.5
    right=172.16.1.5
    mark=5/0xffffffff
    vti-interface=vti01
    vti-routing=no
    vti-shared=yes
    leftvti=192.168.20.1/30
    rightvti=192.168.20.2/30

include /etc/ipsec.d/*.conf
```
```debian
%any %any : PSK "TheSecretMustBeAtLeast13bytes"
```

```debian
systemctl restart ipsec.service
```
